# QA Architect Review: Streamline Studio

**Status**: COMPLETE
**Date**: 2025-12-08
**Reviewer**: QA Architect Agent
**Documents Reviewed**:

- `20251208-streamline-studio-plan.md`
- `20251208-lead-dev-decisions.md`

---

## Executive Summary

The strategic plan and lead developer decisions are fundamentally sound. The architecture choices (Drizzle, tRPC, Lucia Auth, app-level multi-tenancy) are pragmatic for MVP scope. However, this review identifies several critical gaps that could cause data loss, security vulnerabilities, or poor user experience if not addressed before implementation begins.

**Overall Assessment**: Ready for implementation with conditions. Five critical issues must be resolved in Phase 1, and several edge cases need explicit handling documented before development proceeds.

---

## Part 1: Critical Issues (Must Address Before Implementation)

### Critical Issue 1: Auto-Save Data Loss Scenario

**Problem**: Phase 2 specifies auto-save with 2-second debounce (task 2.3.5), but the plan has no mechanism to handle save failures or offline scenarios. Users could type for extended periods while unaware that saves are failing.

**Impact**: User loses work. This is the most common cause of user frustration in document editing applications. Given this is a content planning tool where scripts may be lengthy, data loss could mean hours of work.

**Proposed Fix**:

1. Add visual save indicator with three states: "Saved", "Saving...", "Save failed - click to retry"
2. Implement local storage backup that persists unsaved changes
3. On page load, check for local backup newer than server version and offer recovery
4. Queue failed saves and retry with exponential backoff
5. Before page unload, warn if unsaved changes exist

**Phase**: Must be part of Phase 2 core scope, not a nice-to-have.

---

### Critical Issue 2: Concurrent Edit Collision Before Phase 3

**Problem**: Phase 3 introduces optimistic locking, but Phase 2 has no protection against concurrent edits. If a user opens the same document in two tabs (or two users in multi-tenant mode), the last save wins silently. Users have no indication their work was overwritten.

**Impact**: Data loss. User saves work, another tab/user saves different work, first user's changes are gone without warning.

**Proposed Fix**:

1. Add basic version check in Phase 2 document saves (not full optimistic locking, just a warning)
2. On save, if server version > client version, show warning modal: "This document was modified. Reload to see changes?"
3. This provides basic protection until Phase 3 implements full conflict resolution

**Phase**: Must be in Phase 2, not deferred to Phase 3.

---

### Critical Issue 3: Setup Wizard Security Gap

**Problem**: The setup wizard (Phase 4) creates the first admin user, but there is no protection if the database is wiped but the container restarts. An attacker who can reach the application URL could create their own admin account.

**Impact**: Complete system compromise in self-hosted scenarios. Attacker gains admin access to the entire workspace.

**Proposed Fix**:

1. Setup wizard must check `SETUP_COMPLETED=true` environment variable OR a flag file in persistent storage
2. After first user creation, set a persistent flag (not just database presence)
3. If container restarts with empty database but setup flag exists, show error: "Database appears reset. Restore from backup or delete /data/.setup-complete to re-run wizard"
4. Document this clearly in troubleshooting guide

**Phase**: Phase 4, but design must be finalized before Phase 4 begins.

---

### Critical Issue 4: Rate Limiting Bypass via IP Spoofing

**Problem**: Rate limiting is specified as "5 attempts per minute per IP" (task 1.3.10). However, when deployed behind a reverse proxy (common for self-hosted), the IP will be the proxy's IP unless configured correctly.

**Impact**: Rate limiting ineffective. Attacker can brute-force passwords.

**Proposed Fix**:

1. Document that `TRUSTED_PROXY=true` environment variable must be set when behind reverse proxy
2. When enabled, use `X-Forwarded-For` header (rightmost non-private IP)
3. Validate proxy configuration in health check (warn if requests have no X-Forwarded-For but TRUSTED_PROXY=true)
4. Default to connection IP when not behind proxy
5. Add explicit documentation with examples for nginx, Traefik, Caddy proxy configurations

**Phase**: Phase 1, with documentation completed in Phase 4.

---

### Critical Issue 5: Missing CSRF Protection for Mutations

**Problem**: The plan mentions "verify Origin header for mutations" as CSRF protection, but this is incomplete. Origin header verification alone does not protect against all CSRF vectors (some browsers/proxies strip Origin).

**Impact**: Potential CSRF attacks could modify or delete user data.

**Proposed Fix**:

1. Implement double-submit cookie pattern OR synchronizer token pattern
2. tRPC mutations should validate a CSRF token in addition to session cookie
3. For tRPC specifically, verify the `Content-Type: application/json` header (browsers don't send JSON in form submissions)
4. Add Origin/Referer validation as defense-in-depth, not primary protection

**Phase**: Phase 1, part of auth implementation.

---

## Part 2: Edge Cases and Failure Modes

### 2.1 Document Versioning Edge Cases

| Scenario                                                            | Current Handling        | Risk Level     | Recommendation                                                                                                            |
| ------------------------------------------------------------------- | ----------------------- | -------------- | ------------------------------------------------------------------------------------------------------------------------- |
| **Rapid saves (typing fast, auto-save triggers multiple times)**    | Not specified           | Medium         | Debounce must be resilient to overlapping save requests. Queue saves, process sequentially, use version for ordering.     |
| **Large document (50KB+ markdown)**                                 | No size limit mentioned | Medium         | Add document size limit (suggest 500KB). Display character count with warning at 80% of limit.                            |
| **Save during network interruption**                                | Not specified           | High           | Local queue with retry. Never lose typed content. See Critical Issue 1.                                                   |
| **Version integer overflow**                                        | Uses integer type       | Low            | At 1 save/second, overflow in 68 years. Not a practical concern, but use bigint for paranoia.                             |
| **Restore creates new version - revision table grows unbounded**    | Acknowledged in risks   | Medium         | Add `max_revisions_per_document` config. When exceeded, delete oldest revisions (keeping first and last N). Default: 100. |
| **Two tabs: Tab A at v1, Tab B saves v2, Tab A saves expecting v1** | Phase 3 handles         | High before P3 | See Critical Issue 2 for Phase 2 mitigation.                                                                              |
| **User restores v5, then restores v3 - version sequence**           | Not specified           | Low            | Clarify: restore always creates new version (v7), not reverting to old version number. Document this UX.                  |

### 2.2 Multi-Tenancy Edge Cases

| Scenario                                                           | Current Handling                    | Risk Level | Recommendation                                                                                                             |
| ------------------------------------------------------------------ | ----------------------------------- | ---------- | -------------------------------------------------------------------------------------------------------------------------- |
| **Middleware bypass via direct API call**                          | Repository pattern enforces scoping | Medium     | Add integration tests that attempt direct DB queries without middleware. Fail CI if possible.                              |
| **User removed from workspace while actively editing**             | Not specified                       | Medium     | On save, verify user still has workspace access. Return appropriate error. Frontend should redirect to workspace selector. |
| **Workspace deleted while user has documents open**                | Not specified                       | Medium     | Soft-delete workspaces (set `deleted_at`). Show "workspace unavailable" message. Allow data export before hard deletion.   |
| **Admin operations (database queries, debugging)**                 | App-level scoping only              | Low        | Document that admin database queries bypass scoping. Add audit log for direct DB access in production (future).            |
| **User belongs to multiple workspaces - cached workspace context** | Workspace in cookie/URL             | Medium     | Always derive workspace from URL, not cached value. Verify user membership on each request.                                |
| **Invitation token brute-force**                                   | Plan mentions "long random tokens"  | Medium     | Specify: 256-bit random tokens (base64url encoded = 43 chars). 24-hour expiry. 3 attempt limit per token.                  |
| **User invited to same workspace twice**                           | Not specified                       | Low        | Check existing membership before creating invitation. If already member, show friendly message.                            |

### 2.3 Self-Hosting Edge Cases

| Scenario                                            | Current Handling                  | Risk Level | Recommendation                                                                                                                           |
| --------------------------------------------------- | --------------------------------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **First run: database not ready yet**               | Task 4.3.6 mentions error display | High       | Add retry with backoff (5 attempts over 30 seconds). Display progress: "Connecting to database... (attempt 2/5)"                         |
| **Migration fails mid-way**                         | Not specified                     | High       | Migrations must be idempotent. Add migration status table. On startup, check status and resume or fail clearly.                          |
| **Backup restore to different version**             | Not specified                     | Medium     | Document: restore backup, then run migrations. Warn about schema compatibility.                                                          |
| **Disk full during operation**                      | Not specified                     | Medium     | Health check should include disk space. Graceful degradation: read-only mode when disk critically low.                                   |
| **Container restart loses in-memory rate limiting** | Upstash in-memory suggested       | Medium     | For self-hosted, rate limiting must persist. Options: PostgreSQL table for rate limiting, or accept reset on restart with documentation. |
| **User changes DATABASE_URL between restarts**      | Not specified                     | High       | Detect database change (store hash of connection string). Warn user: "Database appears different. This may cause issues."                |
| **Upgrade from v1.0 to v1.5 skipping v1.2**         | Not specified                     | Medium     | Migrations must be sequential and cumulative. Document: always upgrade to latest, migrations are versioned.                              |

### 2.4 Authentication Edge Cases

| Scenario                                    | Current Handling            | Risk Level | Recommendation                                                                                                       |
| ------------------------------------------- | --------------------------- | ---------- | -------------------------------------------------------------------------------------------------------------------- |
| **Session hijacking via stolen cookie**     | HTTP-only, Secure, SameSite | Low        | Good baseline. Consider: session binding to IP/User-Agent (optional, with UX tradeoff).                              |
| **Password requirements not specified**     | Not mentioned               | Medium     | Minimum 8 characters. Check against common password list (top 10,000). No complexity requirements (they don't help). |
| **Timing attacks on login**                 | Not specified               | Low        | Always hash password before comparison, even for non-existent users. Lucia likely handles this.                      |
| **Account enumeration via registration**    | Not specified               | Low        | "Email already registered" reveals account existence. Consider: "If email exists, check your inbox" for all cases.   |
| **Session invalidation on password change** | Not specified               | Medium     | On password change, invalidate all sessions except current. Offer "sign out everywhere" option.                      |
| **Rate limiting: distributed attack**       | Per-IP limiting             | Medium     | Also add per-email limiting (3 attempts per email per hour). Prevents targeting single account from multiple IPs.    |
| **Remember me vs session cookie**           | 30-day refresh on activity  | Low        | Current approach is reasonable. Document: closing browser does not log out (session cookie with expiry).             |

---

## Part 3: Testability Assessment

### 3.1 Acceptance Criteria Specificity

| Phase       | Criteria Quality | Issues                                                                                                                                                      |
| ----------- | ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 1** | Good             | Specific and testable. Add: "Rate limiting blocks 6th attempt within 60 seconds"                                                                            |
| **Phase 2** | Good             | Add: "Auto-save indicator shows correct state within 500ms of state change"                                                                                 |
| **Phase 3** | Good             | Add: "Conflict modal appears within 1 second of save attempt with stale version"                                                                            |
| **Phase 4** | Moderate         | "Documentation tested by unfamiliar user" is subjective. Define: "User with Docker experience can complete setup in under 15 minutes without external help" |
| **Phase 5** | Good             | Add: "Role change takes effect on next page navigation, not requiring re-login"                                                                             |

### 3.2 Missing E2E Scenarios

The following critical paths are not explicitly covered in acceptance criteria:

1. **Happy path: Complete video lifecycle**
   - Create video -> write script -> add description -> change status through workflow -> mark published

2. **Error recovery: Network failure during save**
   - Start editing -> disable network -> continue typing -> re-enable network -> verify no data loss

3. **Multi-tab conflict resolution**
   - Open same document in two tabs -> edit in Tab A -> save -> edit in Tab B -> attempt save -> verify conflict UI

4. **First-time self-hoster journey**
   - Fresh `docker-compose up` -> complete wizard -> create first video -> restart containers -> verify data persists

5. **Workspace isolation verification**
   - Create two workspaces -> add video to workspace A -> switch to workspace B -> verify video not visible via UI or API manipulation

6. **Role enforcement (Phase 5)**
   - Viewer attempts edit via UI (should be disabled) -> Viewer attempts edit via direct API call (should fail with 403)

### 3.3 Critical Integration Tests

| Test                                                     | Priority | Notes                                                               |
| -------------------------------------------------------- | -------- | ------------------------------------------------------------------- |
| Repository layer enforces workspace scoping              | Critical | Every query type must be tested                                     |
| Session validation rejects expired/invalid tokens        | Critical | Test edge cases: corrupted cookie, expired session, revoked session |
| Document version increment is atomic                     | Critical | Concurrent save attempts should never produce duplicate versions    |
| Migration runs successfully on fresh database            | Critical | Test before every release                                           |
| Migration runs successfully on previous version database | Critical | Test upgrade path                                                   |
| CSRF protection blocks cross-origin mutations            | Critical | Test with actual cross-origin request                               |
| Rate limiting blocks excessive attempts                  | High     | Test with programmatic login attempts                               |
| Health endpoint reflects actual system state             | High     | Test when DB is down                                                |

---

## Part 4: Simplicity Check

### 4.1 Potential Over-Engineering for MVP

| Feature                                | Assessment                  | Recommendation                                                                                              |
| -------------------------------------- | --------------------------- | ----------------------------------------------------------------------------------------------------------- |
| **Audit log for all metadata changes** | Moderate complexity         | Consider: defer activity feed UI to post-MVP. Keep audit log writes for compliance, but don't build viewer. |
| **Bulk export (zip all documents)**    | Nice-to-have                | Defer to post-MVP. Single document export is sufficient initially.                                          |
| **Category color picker**              | Nice-to-have                | Defer. Use predefined color palette (8-10 colors) instead of full picker.                                   |
| **Revision history pagination**        | Needed but scope creep risk | Keep scope limited: show latest 20 revisions, "load more" button. No complex filtering.                     |
| **Workspace slug customization**       | Moderate complexity         | Defer custom slugs to post-MVP. Auto-generate only for MVP.                                                 |

### 4.2 Features That Should Be Cut from MVP

1. **Bulk document import/export (3.4.3)** - Single document is sufficient. Bulk adds zip handling complexity.
2. **Activity feed component on video detail (3.3.7)** - Audit log storage is fine, but UI is not MVP-critical.
3. **Billing placeholders (5.5.\*)** - Entire subsection. Premature for MVP. Add when actual billing is implemented.

### 4.3 Hidden Complexity

| Area                              | Hidden Complexity                                                | Mitigation                                                          |
| --------------------------------- | ---------------------------------------------------------------- | ------------------------------------------------------------------- |
| **CodeMirror 6 integration**      | Accessibility customization, mobile handling, keyboard shortcuts | Budget 50% more time than estimated. Don't customize initially.     |
| **Docker multi-arch builds**      | arm64 native dependencies (Argon2), CI/CD complexity             | Test locally on both architectures before committing to multi-arch. |
| **tRPC + App Router**             | Patterns still evolving, caching behavior                        | Follow established patterns. Don't innovate here.                   |
| **Lucia Auth v3**                 | Relatively new, documentation gaps                               | Keep auth layer abstract. If issues arise, swapping is manageable.  |
| **Markdown preview sanitization** | XSS prevention in rendered HTML                                  | Use established library (DOMPurify). Don't roll custom sanitizer.   |

---

## Part 5: Accessibility Gaps

### 5.1 Completeness of Requirements

The plan's accessibility section (2.3, 2.5) is a good foundation but has gaps:

| Missing Requirement                  | WCAG Criterion               | Recommendation                                                                |
| ------------------------------------ | ---------------------------- | ----------------------------------------------------------------------------- |
| **Autocomplete attributes on forms** | 1.3.5 Identify Input Purpose | Add `autocomplete="email"`, `autocomplete="current-password"` to login forms  |
| **Error identification**             | 3.3.1 Error Identification   | Errors must identify which field has the error, not just "validation failed"  |
| **Status messages**                  | 4.1.3 Status Messages        | Auto-save status, form submission success must be announced to screen readers |
| **Orientation**                      | 1.3.4 Orientation            | App must work in both portrait and landscape. Don't lock orientation.         |
| **Text spacing**                     | 1.4.12 Text Spacing          | UI must remain functional when user overrides text spacing                    |
| **Target size**                      | 2.5.5 Target Size (Enhanced) | Touch targets minimum 44x44px                                                 |

### 5.2 Specific WCAG Criteria to Test

**Must test (Level A and AA):**

- 1.1.1 Non-text Content - All images have alt text
- 1.3.1 Info and Relationships - Headings, lists, tables are properly structured
- 1.4.3 Contrast (Minimum) - 4.5:1 for normal text
- 2.1.1 Keyboard - All functionality via keyboard
- 2.1.2 No Keyboard Trap - User can always escape
- 2.4.3 Focus Order - Logical and predictable
- 2.4.7 Focus Visible - Clear focus indicators
- 3.1.1 Language of Page - `lang` attribute on `<html>`
- 4.1.2 Name, Role, Value - All interactive elements have accessible names

**Additional tests for the markdown editor:**

- Can users navigate between editor and preview using keyboard only?
- Are formatting shortcuts announced to screen readers?
- Is the character count accessible (aria-live region)?
- Can users access toolbar buttons with screen reader?

### 5.3 Markdown Editor Accessibility

The plan notes "Consider CodeMirror 6 for better a11y support vs Monaco." This is the right choice, but implementation requires attention:

**Required for CodeMirror 6:**

1. Enable `accessibilityAnnouncements` extension
2. Add custom ARIA labels for toolbar buttons
3. Ensure preview region has `role="region"` and `aria-label="Markdown preview"`
4. Implement keyboard shortcuts with visible reference (? to show shortcuts)
5. Test with NVDA and VoiceOver before Phase 2 completion

**Testing approach:**

- Tab through entire video detail page with screen reader
- Verify editing workflow is fully achievable without mouse
- Test on mobile with VoiceOver/TalkBack

---

## Part 6: Recommended Test Strategy

### 6.1 Unit Test Priorities

| Priority     | Area                                  | Coverage Target | Notes                          |
| ------------ | ------------------------------------- | --------------- | ------------------------------ |
| **Critical** | Password hashing/verification         | 100%            | Never touch without tests      |
| **Critical** | Session token generation/validation   | 100%            | Security-critical              |
| **Critical** | Workspace scoping in repository layer | 100%            | Data isolation                 |
| **High**     | Document version increment logic      | 100%            | Data integrity                 |
| **High**     | Rate limiting logic                   | 90%             | Edge cases around time windows |
| **High**     | Input validation (tRPC schemas)       | 90%             | All user inputs                |
| **Medium**   | Markdown sanitization                 | 80%             | XSS prevention                 |
| **Medium**   | Status workflow validation            | 80%             | Valid status transitions       |

### 6.2 Integration Test Priorities

| Priority     | Test                             | Description                                                            |
| ------------ | -------------------------------- | ---------------------------------------------------------------------- |
| **Critical** | Cross-tenant data isolation      | User A cannot access User B's workspace data via any API endpoint      |
| **Critical** | Auth flow complete cycle         | Register -> login -> access protected route -> logout -> cannot access |
| **Critical** | Document save with version check | Concurrent saves produce correct versions                              |
| **Critical** | Migration on fresh database      | All tables created, indexes exist, seed works                          |
| **High**     | Session expiry and refresh       | Session expires after 30 days, refreshes on activity                   |
| **High**     | Rate limiting enforcement        | 6th login attempt within 60 seconds returns 429                        |
| **High**     | Health endpoint accuracy         | Returns 500 when database unavailable                                  |
| **Medium**   | Category deletion unlinking      | Deleting category does not delete associated videos                    |
| **Medium**   | Revision creation on save        | Each save creates revision entry                                       |

### 6.3 E2E Test Scenarios (Critical Paths)

**Scenario 1: First-Time Setup (Self-Hosted)**

```
Given: Fresh docker-compose up
When: User navigates to application URL
Then: Setup wizard is displayed
When: User enters admin email and password
Then: User is logged in and redirected to empty dashboard
When: Containers are restarted
Then: User can log in with same credentials
And: Setup wizard is not shown
```

**Scenario 2: Video Lifecycle**

```
Given: Logged-in user with workspace
When: User creates video "My First Video"
Then: Video appears in list with status "Idea"
When: User opens video and edits script
Then: Auto-save triggers after 2 seconds of inactivity
And: Save indicator shows "Saved"
When: User changes status to "Scripting"
Then: Status change is reflected immediately
And: Audit log records the change
```

**Scenario 3: Conflict Detection**

```
Given: Document open in two browser tabs (Tab A and Tab B)
When: User edits in Tab A and saves
Then: Tab A shows "Saved"
When: User edits in Tab B (still showing old version) and saves
Then: Tab B shows conflict modal
And: Options to reload or force save are available
```

**Scenario 4: Workspace Isolation (Multi-Tenant)**

```
Given: Two users in different workspaces
When: User A creates video "Secret Video"
Then: Video is visible to User A
When: User B searches for "Secret Video"
Then: No results are found
When: User B attempts direct API call for User A's video ID
Then: 404 or 403 is returned (not the video data)
```

**Scenario 5: Role Enforcement (Phase 5)**

```
Given: Viewer role user in workspace
When: User views video list
Then: Edit buttons are not visible
When: User attempts direct navigation to edit URL
Then: Access denied message is shown
When: User attempts API mutation
Then: 403 Forbidden is returned
```

### 6.4 Manual Testing Requirements

| Area                            | Why Manual                                     | Checklist                                                                                                                                |
| ------------------------------- | ---------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **Screen reader compatibility** | Automated tools miss real-world usage patterns | - Navigate entire app with VoiceOver (macOS) - Complete video creation flow with NVDA (Windows) - Test on mobile with TalkBack (Android) |
| **Keyboard navigation**         | Tab order, focus traps need human judgment     | - Tab through all pages - Complete all forms without mouse - Escape from all modals - Access all toolbar buttons                         |
| **First-time user experience**  | Subjective assessment of clarity               | - Fresh user (not developer) completes setup - Note any confusion points - Document time to first successful video                       |
| **Error message clarity**       | Requires human assessment                      | - Trigger all error states - Assess: Is it clear what went wrong? - Assess: Is it clear what to do next?                                 |
| **Mobile responsiveness**       | Edge cases on real devices                     | - Test on iPhone SE (small screen) - Test on iPad (tablet layout) - Test sidebar collapse/expand                                         |

---

## Part 7: Final Verdict

### Is This Plan Ready for Implementation?

**Yes, with conditions.**

The plan demonstrates thorough thinking about architecture, security, and user experience. The lead developer decisions are well-reasoned and appropriately scoped for MVP. The modified linear approach with early Docker validation is pragmatically risk-balanced.

### What Must Be Addressed First (Before Phase 1 Development)

1. **Critical Issue 1 (Auto-Save Data Loss)**: Add local storage backup and save state indicator to Phase 2 core scope. This is non-negotiable for a document editing application.

2. **Critical Issue 2 (Concurrent Edit Collision)**: Add basic version check to Phase 2. Full optimistic locking can wait for Phase 3, but users must not lose data in Phase 2.

3. **Critical Issue 3 (Setup Wizard Security)**: Design the persistent setup flag mechanism before Phase 4 implementation.

4. **Critical Issue 4 (Rate Limiting Proxy)**: Document trusted proxy configuration in Phase 1. Add proxy detection warning in Phase 4 documentation.

5. **Critical Issue 5 (CSRF Protection)**: Implement proper CSRF protection in Phase 1 auth, not just Origin header verification.

### What Can Be Deferred

| Item                             | Defer To                 | Rationale                                  |
| -------------------------------- | ------------------------ | ------------------------------------------ |
| Bulk document export (zip)       | Post-MVP                 | Nice-to-have, adds complexity              |
| Activity feed UI                 | Post-MVP                 | Keep audit log writes, defer viewer        |
| Billing placeholders             | When billing implemented | Premature abstraction                      |
| Workspace slug customization     | Post-MVP                 | Auto-generate is sufficient                |
| Category color picker            | Post-MVP                 | Preset palette is enough                   |
| Full revision history pagination | Post-MVP                 | "Load more" button is sufficient initially |

### Final Notes

The collaboration between Planning Agent and Lead Developer has produced a solid foundation. The key insight from this review is that **data loss prevention must be elevated to a first-class concern** from Phase 2 onwards. Document editing applications live or die by user trust in data integrity.

The multi-tenancy approach (app-level scoping) is acceptable for MVP but requires rigorous testing. The integration test suite for workspace isolation should be comprehensive and run on every CI build.

The accessibility requirements are good but need the specific additions noted in Part 5. Budget time for screen reader testing - it often reveals issues that automated tools miss.

Proceed with implementation. The plan is solid. Address the critical issues, test rigorously, and ship.

---

## Appendix A: Test File Structure Recommendation

```
tests/
  unit/
    auth/
      password.test.ts
      session.test.ts
    repository/
      workspace-scoping.test.ts
    validation/
      input-schemas.test.ts
  integration/
    auth/
      login-flow.test.ts
      rate-limiting.test.ts
    data/
      cross-tenant-isolation.test.ts
      document-versioning.test.ts
    infrastructure/
      migration.test.ts
      health-check.test.ts
  e2e/
    setup-wizard.spec.ts
    video-lifecycle.spec.ts
    conflict-detection.spec.ts
    workspace-isolation.spec.ts
    role-enforcement.spec.ts
  accessibility/
    axe-audit.spec.ts
    keyboard-navigation.spec.ts
```

---

## Appendix B: Security Checklist for Each Phase

### Phase 1 Security Sign-Off

- [ ] Password hashing uses Argon2id
- [ ] Session tokens are cryptographically random (256-bit minimum)
- [ ] Cookies are HTTP-only, Secure, SameSite=Lax
- [ ] Rate limiting is in place and tested
- [ ] CSRF protection is implemented
- [ ] Environment variables validated at startup
- [ ] No secrets in logs

### Phase 4 Security Sign-Off

- [ ] Setup wizard locked after first user
- [ ] No default credentials
- [ ] HTTPS documentation is clear
- [ ] Health endpoint does not leak sensitive info
- [ ] Docker image has minimal attack surface

### Phase 5 Security Sign-Off

- [ ] Cross-tenant isolation verified by penetration test
- [ ] Invitation tokens are sufficiently random and expire
- [ ] Role-based access control enforced at API layer
- [ ] Email sending does not allow header injection

---

## Revision History

| Date       | Version | Changes           |
| ---------- | ------- | ----------------- |
| 2025-12-08 | 1.0     | Initial QA review |
