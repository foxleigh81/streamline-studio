# =============================================================================
# CI Environment Configuration
# =============================================================================
# This file documents the EXACT environment variables used in GitHub Actions CI.
# Use this to replicate CI conditions locally for debugging test failures.
#
# To run tests in CI mode locally:
#   npm run test:e2e:ci-mode
#
# Or manually set these variables before running tests.
# =============================================================================

# =============================================================================
# DATABASE - Fresh PostgreSQL instance for each CI run
# =============================================================================
# CI uses a fresh PostgreSQL 16 container with these credentials.
# The database is created empty and migrations are applied fresh.
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/streamline_test
PGUSER=postgres
PGPASSWORD=postgres
PGHOST=127.0.0.1
PGPORT=5432

# =============================================================================
# APPLICATION MODE
# =============================================================================
MODE=single-tenant

# =============================================================================
# SESSION - Test-only secret (DO NOT use in production)
# =============================================================================
SESSION_SECRET=test-secret-for-ci-only-do-not-use-in-production

# =============================================================================
# DATA DIRECTORY - Ephemeral storage for CI
# =============================================================================
# CI creates this directory fresh and adds .setup-complete flag BEFORE build.
# This is critical: the setup flag must exist at build time to avoid
# static pages baking in redirects to /setup.
DATA_DIR=/tmp/streamline-data

# =============================================================================
# E2E TEST MODE - Relaxed rate limiting
# =============================================================================
# When true, rate limits are increased 100x to prevent blocking tests.
# This is REQUIRED for E2E tests to pass.
E2E_TEST_MODE=true

# =============================================================================
# NODE ENVIRONMENT - Production build in CI
# =============================================================================
# CI builds and tests against production build (standalone server),
# NOT the dev server. This catches issues that only appear in production.
NODE_ENV=production

# =============================================================================
# CI-SPECIFIC BEHAVIOR DIFFERENCES
# =============================================================================
# 1. DATABASE: Fresh database with migrations applied, then seeded with db:seed
# 2. BUILD: Production standalone build (npm run build), not dev server
# 3. SETUP FLAG: Created BEFORE build at $DATA_DIR/.setup-complete
# 4. STATIC ASSETS: Manually copied to .next/standalone/ for standalone server
# 5. RETRIES: Playwright configured with 1 retry in CI (0 locally by default)
# 6. WORKERS: 4 parallel workers (may differ from local machine)
# 7. BROWSER: Only Chromium (not Firefox/WebKit)

# =============================================================================
# LOCAL CI MODE SETUP
# =============================================================================
# To replicate CI conditions locally:
#
# 1. Start a fresh PostgreSQL database:
#    docker run --rm -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres \
#      -e POSTGRES_DB=streamline_test -p 5432:5432 postgres:16
#
# 2. Create DATA_DIR and setup flag:
#    mkdir -p /tmp/streamline-data
#    echo '{"completed":true,"timestamp":"2024-01-01T00:00:00.000Z","version":"1.0"}' > /tmp/streamline-data/.setup-complete
#
# 3. Run migrations and seed:
#    DATABASE_URL="postgresql://postgres:postgres@localhost:5432/streamline_test" npm run db:migrate
#    DATABASE_URL="postgresql://postgres:postgres@localhost:5432/streamline_test" npm run db:seed
#
# 4. Build production:
#    DATABASE_URL="postgresql://postgres:postgres@localhost:5432/streamline_test" \
#    DATA_DIR=/tmp/streamline-data \
#    SESSION_SECRET=test-secret-for-ci-only-do-not-use-in-production \
#    MODE=single-tenant npm run build
#
# 5. Copy static assets:
#    cp -r .next/static .next/standalone/.next/static
#    cp -r public .next/standalone/public
#
# 6. Run E2E tests:
#    npm run test:e2e:ci-mode
#
# Or simply run: npm run test:e2e:ci-mode (which does all of this automatically)
