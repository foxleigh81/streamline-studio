name: Docker Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract platform name
        id: platform
        run: echo "name=$(echo ${{ matrix.platform }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: false
          tags: streamline-studio:test-${{ steps.platform.outputs.name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-test:
    name: Test Docker Deployment
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=test-password-$(openssl rand -hex 12)
          DATABASE_URL=postgresql://streamline:test-password-$(openssl rand -hex 12)@db:5432/streamline
          SESSION_SECRET=$(openssl rand -base64 32)
          MODE=single-tenant
          TRUSTED_PROXY=false
          DATA_DIR=/data
          EOF

      - name: Start services
        run: docker-compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for app to be healthy..."
          timeout 120 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'

      - name: Check health endpoint
        run: |
          response=$(curl -s http://localhost:3000/api/health)
          echo "Health check response: $response"
          echo "$response" | jq -e '.status == "ok"'

      - name: Check setup redirect
        run: |
          # Should redirect to /setup on first run
          curl -I http://localhost:3000 | grep -E "Location.*setup"

      - name: Check logs
        if: always()
        run: |
          echo "=== App Logs ==="
          docker-compose logs app
          echo "=== DB Logs ==="
          docker-compose logs db

      - name: Stop services
        if: always()
        run: docker-compose down -v

  docker-size-check:
    name: Check Image Size
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t streamline-studio:size-check .

      - name: Check image size
        run: |
          size=$(docker images streamline-studio:size-check --format "{{.Size}}")
          echo "Image size: $size"

          # Extract size in MB (rough calculation)
          size_mb=$(docker images streamline-studio:size-check --format "{{.Size}}" | sed 's/MB//' | sed 's/GB/*1024/' | bc)

          echo "Size in MB: $size_mb"

          # Fail if larger than 200MB (ADR-011 requirement)
          if (( $(echo "$size_mb > 200" | bc -l) )); then
            echo "ERROR: Image size ($size_mb MB) exceeds 200MB limit"
            exit 1
          fi

          echo " Image size is within 200MB limit"
