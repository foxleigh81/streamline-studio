# Settings Page Implementation - Task Breakdown

**Status**: Ready for Assignment
**Created**: 2025-12-16
**Related Plan**: [settings-page-implementation-plan.md](./settings-page-implementation-plan.md)

## Quick Reference

**Total Phases**: 6 core phases (+ 2 optional)
**Estimated Total Time**: 24-35 hours
**Critical Path**: Phases 1 → 2 → 3 → 5 (for default channel feature)

## Phase Dependency Chart

```
Phase 1: Database Schema (no deps)
    ↓
Phase 2: tRPC API
    ↓
Phase 3: Preferences Page ← Phase 4: Settings Layout (parallel)
    ↓
Phase 5: Default Channel Redirect
    ↓
Phase 6: View Mode Migration
    ↓
Phase 7: Testing & Docs
```

---

## Phase 1: Database Schema & Migration

**Assignee**: Senior Next.js Developer
**Reviewers**: Code Quality Enforcer, Security Architect
**Estimated Time**: 2-4 hours
**Priority**: Critical (blocks all other phases)

### Tasks

- [ ] 1.1: Add `userPreferences` table to `/src/server/db/schema.ts`
  - Include all enums: theme, dateFormat, timeFormat, viewMode
  - Add relations to users and channels tables
  - Export TypeScript types

- [ ] 1.2: Generate migration: `npm run db:generate`

- [ ] 1.3: Test migration locally: `npm run db:migrate`

- [ ] 1.4: Verify schema in Drizzle Studio: `npm run db:studio`

- [ ] 1.5: Test rollback (drop table and re-run migration)

### Acceptance Criteria

- [ ] Schema compiles without TypeScript errors
- [ ] Migration applies cleanly to empty database
- [ ] Migration applies cleanly to database with existing users
- [ ] Can query `userPreferences` via Drizzle in Node REPL
- [ ] All relations work correctly
- [ ] TypeScript types exported and importable

### Deliverables

- Updated `/src/server/db/schema.ts`
- Migration file in `/drizzle/migrations/`
- Schema reference in implementation plan (Appendix A)

---

## Phase 2: tRPC API Layer

**Assignee**: Senior Next.js Developer
**Reviewers**: Code Quality Enforcer, Security Architect
**Estimated Time**: 4-6 hours
**Priority**: Critical (blocks Phase 3, 5, 6)
**Dependencies**: Phase 1 complete

### Tasks

- [ ] 2.1: Create Zod schemas in `/src/server/trpc/routers/user.ts`
  - `updatePreferencesInputSchema`
  - Enum schemas for theme, dateFormat, timeFormat, viewMode

- [ ] 2.2: Implement `getPreferences` procedure
  - Query user preferences
  - Return defaults if no record exists
  - Handle null values gracefully

- [ ] 2.3: Implement `updatePreferences` procedure
  - Upsert logic (insert or update)
  - Partial updates (only changed fields)
  - Validate defaultChannelId if provided
  - Check user has access to default channel

- [ ] 2.4: Implement `getAvailableChannels` procedure
  - Query channels user has access to
  - Join with teamspaces for display
  - Order by name

- [ ] 2.5: Create unit tests in `__tests__/user-preferences.test.ts`
  - Test getPreferences with no existing record
  - Test getPreferences with existing record
  - Test updatePreferences creates new record
  - Test updatePreferences updates existing record
  - Test defaultChannelId validation
  - Test authorization (user can't set channel they don't have access to)
  - Test partial updates

- [ ] 2.6: Run tests and achieve 100% coverage: `npm run test:coverage`

### Acceptance Criteria

- [ ] All tRPC procedures implemented
- [ ] Zod schemas validate inputs correctly
- [ ] Default channel authorization prevents unauthorized access
- [ ] Unit tests achieve 100% coverage
- [ ] Tests pass in CI
- [ ] TypeScript types auto-generated by tRPC

### Deliverables

- Updated `/src/server/trpc/routers/user.ts`
- New `/src/server/trpc/routers/__tests__/user-preferences.test.ts`
- tRPC router reference in implementation plan (Appendix B)

---

## Phase 3: Preferences Settings Page

**Assignee**: Senior Next.js Developer
**Reviewers**: TRON User Advocate, Code Quality Enforcer
**Estimated Time**: 6-8 hours
**Priority**: High
**Dependencies**: Phase 2 complete

### Tasks

- [ ] 3.1: Check if UI components exist, create if needed
  - [ ] Check `/src/components/ui/select.tsx` exists
  - [ ] Check `/src/components/ui/radio-group.tsx` exists
  - [ ] Create missing components following Button/Input patterns
  - [ ] Create Storybook stories for new components

- [ ] 3.2: Create preferences page
  - Path: `/src/app/(app)/t/[teamspace]/settings/preferences/page.tsx`
  - Client component (uses tRPC hooks)
  - Follow pattern from `account/page.tsx`

- [ ] 3.3: Implement UI sections
  - [ ] Section 1: Default Channel (Select dropdown)
  - [ ] Section 2: Content Plan View Mode (Radio group)
  - [ ] Section 3: Appearance / Theme (Radio group) - optional
  - [ ] Section 4: Date & Time formats (Select dropdowns) - optional

- [ ] 3.4: Implement state management
  - Use `trpc.user.getPreferences.useQuery()` to load
  - Use `trpc.user.updatePreferences.useMutation()` to save
  - Debounce updates (500ms) to avoid excessive API calls
  - Show success/error feedback (toasts or inline messages)

- [ ] 3.5: Create SCSS module
  - Path: `page.module.scss`
  - Follow patterns from `account/page.module.scss`
  - Use theme variables from `/src/themes/default/`
  - Ensure responsive design (mobile, tablet, desktop)

- [ ] 3.6: Accessibility review
  - All form controls keyboard accessible
  - Labels and ARIA attributes correct
  - Color contrast meets WCAG AA
  - Test with screen reader

### Acceptance Criteria

- [ ] Preferences page renders all sections
- [ ] Default channel dropdown populated with user's channels
- [ ] "None" option to disable default channel
- [ ] All form controls functional and update database
- [ ] Debouncing works (doesn't spam API)
- [ ] Success/error feedback displayed to user
- [ ] SCSS follows project conventions
- [ ] Page is keyboard accessible (WCAG 2.1 AA)
- [ ] Loading states handled gracefully
- [ ] Works correctly with no existing preferences (shows defaults)

### Deliverables

- `/src/app/(app)/t/[teamspace]/settings/preferences/page.tsx`
- `/src/app/(app)/t/[teamspace]/settings/preferences/page.module.scss`
- New UI components (if needed):
  - `/src/components/ui/select.tsx` + `.module.scss`
  - `/src/components/ui/radio-group.tsx` + `.module.scss`
- Storybook stories for new components

---

## Phase 4: Settings Layout & Navigation

**Assignee**: Senior Next.js Developer
**Reviewers**: TRON User Advocate
**Estimated Time**: 2-3 hours
**Priority**: Medium (can be done in parallel with Phase 3)
**Dependencies**: None

### Tasks

- [ ] 4.1: Create settings layout
  - Path: `/src/app/(app)/t/[teamspace]/settings/layout.tsx`
  - Sidebar navigation for settings sections
  - Active link highlighting
  - Responsive design (collapse to dropdown on mobile)

- [ ] 4.2: Define navigation items
  - Link to `/account` (existing)
  - Link to `/preferences` (new)
  - Placeholder for `/notifications` (future)

- [ ] 4.3: Add settings link to main navigation
  - Add to user menu in header (if exists)
  - Icon: Settings/gear icon
  - Default to `/t/[teamspace]/settings/account`

- [ ] 4.4: Style settings layout
  - Create `layout.module.scss`
  - Use theme variables
  - Ensure consistent spacing/typography

- [ ] 4.5: Accessibility review
  - Keyboard navigation works
  - Active link announced to screen readers
  - Skip links if needed

### Acceptance Criteria

- [ ] Settings layout created with sidebar navigation
- [ ] Active link styling works correctly
- [ ] User can navigate between settings pages
- [ ] Settings link accessible from main navigation
- [ ] Layout is responsive (mobile, tablet, desktop)
- [ ] Breadcrumbs or clear indication of current location
- [ ] Keyboard accessible

### Deliverables

- `/src/app/(app)/t/[teamspace]/settings/layout.tsx`
- `/src/app/(app)/t/[teamspace]/settings/layout.module.scss`
- Updated main navigation (e.g., user menu component)

---

## Phase 5: Default Channel Redirect Logic

**Assignee**: Senior Next.js Developer
**Reviewers**: Security Architect, QA Architect
**Estimated Time**: 3-4 hours
**Priority**: High
**Dependencies**: Phase 2 complete

### Tasks

- [ ] 5.1: Locate login success handler
  - Check `/src/app/(auth)/login/page.tsx`
  - Or auth callback/middleware

- [ ] 5.2: Implement default channel redirect
  - After successful login, query user preferences
  - If `defaultChannelId` is set, redirect to that channel
  - Validate user still has access to the channel
  - If not set or invalid, redirect to teamspace dashboard

- [ ] 5.3: Handle edge cases
  - Default channel was deleted → fallback to dashboard
  - User lost access to default channel → fallback to dashboard
  - Default channel is in different teamspace → should this work?
  - Invalid channel ID → fallback to dashboard

- [ ] 5.4: Add logging
  - Log default channel redirects
  - Log fallback to dashboard (with reason)

- [ ] 5.5: Prevent redirect loops
  - Ensure redirect doesn't trigger on every page load
  - Only redirect from login or teamspace root

- [ ] 5.6: Create E2E test
  - Test default channel redirect works
  - Test fallback when channel deleted
  - Test fallback when access revoked
  - Test no redirect when not set

### Acceptance Criteria

- [ ] User with default channel set lands on that channel after login
- [ ] User without default channel lands on teamspace dashboard
- [ ] No redirect loops
- [ ] Works correctly if default channel is deleted
- [ ] Works correctly if user loses access to default channel
- [ ] Redirect is fast (< 100ms)
- [ ] Proper logging for debugging

### Deliverables

- Updated login handler (likely `/src/app/(auth)/login/page.tsx`)
- E2E test: `/e2e/settings/default-channel.spec.ts`
- Documentation of redirect logic

---

## Phase 6: Content Plan View Mode Migration

**Assignee**: Senior Next.js Developer
**Reviewers**: QA Architect
**Estimated Time**: 3-4 hours
**Priority**: High
**Dependencies**: Phase 2 complete

### Tasks

- [ ] 6.1: Update content plan page
  - Path: `/src/app/(app)/t/[teamspace]/[channel]/content-plan/page.tsx`
  - Remove localStorage logic (lines 77-91)
  - Load view mode from `trpc.user.getPreferences.useQuery()`
  - Save view mode via `trpc.user.updatePreferences.useMutation()`

- [ ] 6.2: Implement localStorage migration
  - On first load, check localStorage for `CONTENT_PLAN_VIEW_MODE_KEY`
  - If found, save to database via API
  - Clear localStorage after successful migration
  - Show one-time toast: "Your view preference is now synced across devices"

- [ ] 6.3: Implement optimistic updates
  - View toggle should update immediately (no loading spinner)
  - Use tRPC's optimistic update feature
  - Rollback if mutation fails

- [ ] 6.4: Handle loading states
  - Show default view mode while loading preferences
  - Avoid flash of wrong view mode
  - Use `mounted` state to prevent hydration mismatch

- [ ] 6.5: Add deprecation comment to storage-keys.ts
  - Comment that `CONTENT_PLAN_VIEW_MODE_KEY` is deprecated
  - Will be removed in future version

- [ ] 6.6: Create E2E test
  - Test view mode changes persist to database
  - Test view mode syncs across browser tabs/windows
  - Test localStorage migration (if localStorage has old value)

### Acceptance Criteria

- [ ] View mode loaded from database on page load
- [ ] View mode changes persist to database
- [ ] localStorage preference migrated if exists
- [ ] View mode syncs across devices (test in two browser contexts)
- [ ] Optimistic updates work (instant feedback)
- [ ] Works correctly if preferences query fails (fallback to 'grid')
- [ ] No hydration errors
- [ ] No flash of wrong content

### Deliverables

- Updated `/src/app/(app)/t/[teamspace]/[channel]/content-plan/page.tsx`
- Updated `/src/lib/constants/storage-keys.ts` (deprecation comment)
- E2E test: `/e2e/settings/view-mode-persistence.spec.ts`

---

## Phase 7: Testing & Documentation

**Assignee**: QA Architect (E2E), Senior Next.js Developer (docs)
**Reviewers**: All agents
**Estimated Time**: 4-6 hours
**Priority**: Critical (must complete before merge)
**Dependencies**: Phases 1-6 complete

### Tasks

- [ ] 7.1: Run full test suite locally
  - [ ] `npm run test:coverage` (80%+ coverage required)
  - [ ] `npm run test:e2e`
  - [ ] `npm run lint`
  - [ ] `npm run type-check`

- [ ] 7.2: Create comprehensive E2E test suite
  - [ ] `/e2e/settings/preferences.spec.ts`
    - Navigate to preferences page
    - Update each setting
    - Verify persistence across page reloads
  - [ ] `/e2e/settings/default-channel.spec.ts` (from Phase 5)
    - Set default channel
    - Log out and log in
    - Verify redirect to default channel
  - [ ] `/e2e/settings/view-mode-persistence.spec.ts` (from Phase 6)
    - Change view mode
    - Open in new tab
    - Verify same view mode
  - [ ] `/e2e/settings/cross-device-sync.spec.ts`
    - Simulate two devices (two browser contexts)
    - Change setting in one
    - Verify appears in other (may need manual refresh)

- [ ] 7.3: Accessibility testing
  - [ ] Run axe-core on all new pages
  - [ ] Keyboard navigation test
  - [ ] Screen reader testing (manual)
  - [ ] Color contrast verification

- [ ] 7.4: Update documentation
  - [ ] Update README.md (mention settings features)
  - [ ] Update CONTRIBUTING.md (settings architecture notes)
  - [ ] Consider creating ADR if significant decision made
  - [ ] Add screenshots to docs (optional)

- [ ] 7.5: Create migration guide (if needed)
  - Document localStorage → database migration
  - Note for users: "Settings now sync across devices"

### Acceptance Criteria

- [ ] All unit tests pass (80%+ coverage)
- [ ] All E2E tests pass
- [ ] All accessibility tests pass (WCAG 2.1 AA)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] CI pipeline passes
- [ ] Documentation updated

### Deliverables

- E2E test suite: `/e2e/settings/`
- Updated documentation
- Test coverage report
- Accessibility audit results

---

## Optional Phases (Defer to Future Release)

### Phase 8: Theme System Implementation

**Priority**: Low (defer)
**Estimated Time**: 8-12 hours

This is infrastructure work that requires:
- Duplicating theme files for dark mode
- Creating ThemeProvider context
- Testing all components in both themes
- Ensuring WCAG AA contrast in dark mode

**Recommendation**: Ship with UI in place (dropdown in preferences) but not functional. Implement in v0.2.0.

### Phase 9: Date/Time Formatting

**Priority**: Low (defer or minimal implementation)
**Estimated Time**: 4-6 hours

**Minimal Implementation**:
- Create basic format utility functions
- Update video due date displays only
- Full i18n support can come later

**Recommendation**: Implement basic version (ISO vs US format) or defer entirely.

---

## Pre-Merge Checklist

Before creating PR:

- [ ] All phases 1-7 complete
- [ ] All tests pass locally
- [ ] No console errors in browser
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Storybook builds successfully
- [ ] All new files have proper headers/comments
- [ ] No `console.log` statements (use Pino logger)
- [ ] All TODOs addressed or documented
- [ ] Database migration tested on clean DB
- [ ] Database migration tested on DB with existing data

## Rollout Strategy

1. **Local Testing** (Developer)
   - Run full test suite
   - Manual testing with clean database
   - Manual testing with existing data
   - Test on multiple browsers

2. **Code Review** (All Agents)
   - Code Quality Enforcer: Standards, patterns, best practices
   - Security Architect: Authorization, validation, SQL injection
   - TRON User Advocate: UX, accessibility, usability
   - QA Architect: Test coverage, edge cases

3. **Staging Deployment** (If available)
   - Deploy to staging environment
   - Test with production-like data
   - Get user feedback

4. **Production Deployment**
   - Run migrations (`npm run db:migrate`)
   - Deploy application
   - Monitor logs for errors
   - Monitor performance metrics

## Quick Start: What to Do First

1. **User Decision Point**: Review open questions in main plan
   - Do we want theme system in initial release? **Recommendation: No**
   - Do we want date/time formatting? **Recommendation: Defer**

2. **Assign Phase 1**: Senior Next.js Developer creates database schema

3. **Set up Tracking**: Create issues/cards for each phase

4. **Begin Implementation**: Start Phase 1 immediately

---

## Estimated Timeline

**Minimum Viable Product** (Phases 1-7):
- Database Schema: 2-4 hours
- tRPC API: 4-6 hours
- Preferences Page: 6-8 hours
- Settings Layout: 2-3 hours
- Default Channel: 3-4 hours
- View Mode Migration: 3-4 hours
- Testing & Docs: 4-6 hours

**Total: 24-35 hours** (3-4 days for one developer, or 1-2 days with parallel work)

**With Optional Features** (Phases 8-9):
- Theme System: +8-12 hours
- Date/Time Formatting: +4-6 hours

**Grand Total: 36-53 hours** (5-7 days)

---

## Success Metrics

After completion, verify:

- [ ] User can set default channel and lands there on login
- [ ] View mode persists across devices
- [ ] All settings sync within 5 seconds
- [ ] No performance degradation (< 50ms overhead)
- [ ] 80%+ test coverage maintained
- [ ] WCAG 2.1 AA compliance verified
- [ ] Zero critical bugs in first week

---

## Contact & Escalation

**Questions or Blockers?**
- Escalate to Project Orchestrator
- Document in `/project-management/issues/`
- Tag relevant agent for review

**Need Clarification?**
- Check main implementation plan (comprehensive details)
- Check decision document (architectural rationale)
- Ask user if fundamental requirement unclear
